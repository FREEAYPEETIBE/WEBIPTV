<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NZM IPTV ‚Äî Clean Player</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#071025" />
  <link rel="icon" href="nzm.png">

  <!-- üîê Devtool protection (SAFE ‚Äì activated later in JS) -->
  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@0.3.7"></script>

  <!-- Players -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>

  <style>
    :root{
      --bg:#050509;
      --panel:rgba(255,255,255,0.02);
      --glass: rgba(255,255,255,0.03);
      --accent1:#00d2ff;
      --accent2:#6a5cff;
      --neon: 0 8px 30px rgba(0,210,255,0.08), 0 4px 10px rgba(106,92,255,0.04);
      --text:#e9f6ff;
      --muted:rgba(233,246,255,0.55);
    }
    *{box-sizing:border-box;font-family:Inter, Poppins, Arial, sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#030205 0%, #050509 100%);color:var(--text)}
    .app{display:flex;flex-direction:column;height:100vh;overflow:hidden}

    /* ===== TOP BAR ===== */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;padding:12px 18px;
      backdrop-filter:blur(8px) saturate(1.1);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-bottom: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{height:38px;border-radius:8px;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.6));}
    .brand h1{font-size:18px;color:var(--accent1);margin:0}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .search{
      min-width:220px;display:flex;align-items:center;padding:8px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:26px;gap:10px;border:1px solid rgba(255,255,255,0.03);
    }
    .search input{
      background:transparent;border:none;outline:none;color:var(--text);
      width:100%;font-size:14px
    }

    .btn{
      padding:8px 12px;border-radius:12px;background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      cursor:pointer;color:var(--text);font-weight:600;
    }
    .btn.glow{
      background: linear-gradient(90deg, rgba(0,210,255,0.08), rgba(106,92,255,0.06));
      box-shadow: var(--neon);
    }

    /* ===== CONTENT ===== */
    .content{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:18px}
    .row{display:flex;flex-direction:column;gap:10px}
    .row-header{display:flex;align-items:center;justify-content:space-between}
    .carousel{
      display:flex;gap:12px;overflow:auto;padding:12px 6px;
      scroll-snap-type:x mandatory;
    }

    .card{
      min-width:220px;height:132px;border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:8px;padding:10px;cursor:pointer;position:relative;
    }
    .card img{width:110px;height:70px;border-radius:8px;object-fit:cover}
    .card .name{font-size:14px;text-align:center}

    .badge-live{
      position:absolute;left:10px;top:10px;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      padding:4px 6px;border-radius:6px;font-size:11px;
    }
    .fav-toggle{
      position:absolute;right:10px;top:10px;
      background:rgba(0,0,0,0.45);
      padding:6px;border-radius:8px;cursor:pointer;
    }

    /* ===== PLAYER OVERLAY ===== */
    .overlay{
      position:fixed;inset:0;display:none;
      align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(3,6,12,0.6), rgba(0,0,0,0.85));
      z-index:100;
    }
    .overlay.active{display:flex}

    .player-wrap{
      width:92%;max-width:1280px;aspect-ratio:16/9;
      background:#000;border-radius:14px;overflow:hidden;
      position:relative;
    }

    video,iframe{width:100%;height:100%;background:#000}

    .close-btn{
      position:absolute;left:12px;top:12px;
      background:rgba(0,0,0,0.6);
      padding:8px;border-radius:10px;color:#fff;
      cursor:pointer;z-index:40;
    }

    .loading-spinner{
      position:absolute;inset:0;
      display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.45);z-index:60;
    }
    .spinner{
      width:56px;height:56px;
      border:6px solid rgba(255,255,255,0.12);
      border-top-color: var(--accent1);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== MINI PLAYER ===== */
    .mini-player{
      position:fixed;right:12px;bottom:12px;
      background:rgba(0,0,0,0.75);
      padding:8px;border-radius:10px;
      display:none;gap:8px;align-items:center;
      z-index:9999;
    }
    .mini-player img{width:56px;height:36px;border-radius:6px}

    @media(max-width:900px){
      .card{min-width:170px;height:120px}
    }
  </style>
</head>

<body>
<div class="app">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">
      <img src="nzmm.png">
      <h1>NZM IPTV</h1>
    </div>
    <div class="controls">
      <div class="search">
        <input id="searchInput" placeholder="Search channels or categories" />
      </div>
      <button id="favoritesTab" class="btn glow">‚ù§ Favorites</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content" id="content"></div>

  <!-- MINI PLAYER -->
  <div class="mini-player" id="miniPlayer">
    <img id="miniLogo">
    <div>
      <div id="miniTitle"></div>
      <div id="miniType" style="font-size:12px;opacity:.7"></div>
    </div>
    <button id="miniOpen">‚§¢</button>
    <button id="miniClose">‚úñ</button>
  </div>

  <!-- PLAYER -->
  <div class="overlay" id="overlay">
    <div class="player-wrap" id="playerWrap">
      <button class="close-btn" id="exitPlayer">‚úñ</button>

      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
      </div>

      <video id="playerVideo"
        playsinline
        preload="auto"
        muted
        autoplay
        controlslist="nodownload noremoteplayback nofullscreen noplaybackrate">
      </video>

      <iframe id="playerIframe" style="display:none" allowfullscreen></iframe>
    </div>
  </div>

</div>

  <script>
/* ===========================
   STATE
=========================== */
let favorites = JSON.parse(localStorage.getItem('iptv_favs') || '[]');
let lastPlayed = JSON.parse(localStorage.getItem('lastPlayed') || 'null');

let hls = null;
let shakaPlayer = null;

/* ===========================
   ELEMENTS
=========================== */
const content = document.getElementById('content');
const overlay = document.getElementById('overlay');
const playerWrap = document.getElementById('playerWrap');
const playerVideo = document.getElementById('playerVideo');
const playerIframe = document.getElementById('playerIframe');
const spinner = document.getElementById('loadingSpinner');

const miniPlayer = document.getElementById('miniPlayer');
const miniLogo = document.getElementById('miniLogo');
const miniTitle = document.getElementById('miniTitle');
const miniType = document.getElementById('miniType');

const searchInput = document.getElementById('searchInput');
const favoritesTab = document.getElementById('favoritesTab');
const exitPlayer = document.getElementById('exitPlayer');
const miniOpen = document.getElementById('miniOpen');
const miniClose = document.getElementById('miniClose');

/* ===========================
   SAFE DEVTOOL GUARD
=========================== */
let DEV_GUARD_ACTIVE = false;
function enableDevGuard(){
  if(DEV_GUARD_ACTIVE) return;
  DEV_GUARD_ACTIVE = true;
  DisableDevtool({
    disableMenu:true,
    disableSelect:true,
    disableCopy:true,
    disableCut:true,
    disablePaste:true
  });
}

/* ===========================
   HELPERS
=========================== */
function showSpinner(){ spinner.style.display = 'flex'; }
function hideSpinner(){ spinner.style.display = 'none'; }

function stopAllPlayers(){
  if(hls){ try{ hls.destroy(); }catch(e){} hls = null; }
  if(shakaPlayer){ try{ shakaPlayer.unload(); }catch(e){} shakaPlayer = null; }

  try{
    playerVideo.pause();
    playerVideo.removeAttribute('src');
    playerVideo.load();
  }catch(e){}

  playerIframe.src = '';
  hideSpinner();
}

/* ===========================
   OPEN PLAYER (PATCHED)
=========================== */
async function openPlayer(ch){
  stopAllPlayers();

  overlay.classList.add('active');
  showSpinner();

  playerVideo.style.display = 'none';
  playerIframe.style.display = 'none';

  lastPlayed = {
    name: ch.name,
    url: ch.url,
    type: ch.type,
    logo: ch.logo,
    clearKey: ch.clearKey || null,
    time: new Date().toLocaleString()
  };
  localStorage.setItem('lastPlayed', JSON.stringify(lastPlayed));

  miniLogo.src = ch.logo || 'logo.png';
  miniTitle.textContent = ch.name;
  miniType.textContent = ch.type.toUpperCase();
  miniPlayer.style.display = 'flex';

  /* ===== YOUTUBE ===== */
  if(ch.type === 'youtube'){
    playerIframe.style.display = 'block';
    playerIframe.src = ch.url + (ch.url.includes('?')?'&':'?') + 'autoplay=1';
    hideSpinner();
    return;
  }

  /* ===== VIDEO ===== */
  playerVideo.style.display = 'block';
  playerVideo.muted = true;

  /* ===== HLS (FIXED) ===== */
  if(ch.type === 'hls'){
    if(Hls.isSupported()){
      hls = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 90
      });

      // üîß FIX: loadSource BEFORE attach events
      hls.loadSource(ch.url);
      hls.attachMedia(playerVideo);

      hls.on(Hls.Events.MANIFEST_PARSED, async ()=>{
        hideSpinner();
        try{ await playerVideo.play(); }catch(e){}
      });

      hls.on(Hls.Events.ERROR, (e, data)=>{
        if(data.fatal){
          hls.destroy();
          hideSpinner();
          alert('HLS stream error');
        }
      });

    } else {
      playerVideo.src = ch.url;
      playerVideo.play().catch(()=>{});
      hideSpinner();
    }
  }

  /* ===== DASH ===== */
  else if(ch.type === 'dash'){
    shaka.polyfill.installAll();
    shakaPlayer = new shaka.Player(playerVideo);

    if(ch.clearKey){
      shakaPlayer.configure({ drm:{ clearKeys: ch.clearKey } });
    }

    await shakaPlayer.load(ch.url);
    playerVideo.play().catch(()=>{});
    hideSpinner();
  }

  /* ===== MP4 / OTHERS ===== */
  else {
    playerVideo.src = ch.url;
    playerVideo.play().catch(()=>{});
    hideSpinner();
  }
}

/* ===========================
   AUTOPLAY + FULLSCREEN FIX
=========================== */
playerVideo.addEventListener('playing', ()=>{
  playerVideo.muted = false;

  try{
    if(!document.fullscreenElement){
      playerWrap.requestFullscreen?.().catch(()=>{});
    }
  }catch(e){}

  enableDevGuard(); // üîê safe activation AFTER playback
},{ once:true });

/* ===========================
   CONTROLS
=========================== */
exitPlayer.onclick = async ()=>{
  try{
    if(document.fullscreenElement){
      await document.exitFullscreen();
    }
  }catch(e){}
  stopAllPlayers();
  overlay.classList.remove('active');
};

miniOpen.onclick = ()=>{
  overlay.classList.add('active');
  miniPlayer.style.display = 'none';
};

miniClose.onclick = ()=>{
  stopAllPlayers();
  miniPlayer.style.display = 'none';
};

/* ===========================
   CHANNEL UI
=========================== */
function groupChannels(list){
  const g = {};
  (list || []).forEach(c=>{
    const cat = c.category || c.group || 'Channels';
    if(!g[cat]) g[cat] = [];
    g[cat].push(c);
  });
  return g;
}

function toggleFav(name, el){
  const i = favorites.indexOf(name);
  if(i === -1){
    favorites.push(name);
    el.textContent = '‚ù§';
  }else{
    favorites.splice(i,1);
    el.textContent = '‚ô°';
  }
  localStorage.setItem('iptv_favs', JSON.stringify(favorites));
}

function createRow(title, chs){
  const row = document.createElement('div');
  row.className = 'row';

  const header = document.createElement('div');
  header.className = 'row-header';
  header.innerHTML = `<strong>${title}</strong>`;
  row.appendChild(header);

  const car = document.createElement('div');
  car.className = 'carousel';

  chs.forEach(c=>{
    const card = document.createElement('div');
    card.className = 'card';

    card.innerHTML = `
      ${c.live?'<div class="badge-live">LIVE</div>':''}
      <div class="fav-toggle">${favorites.includes(c.name)?'‚ù§':'‚ô°'}</div>
      <img src="${c.logo||'logo.png'}">
      <div class="name">${c.name}</div>
    `;

    card.onclick = e=>{
      if(e.target.classList.contains('fav-toggle')) return;
      openPlayer(c);
    };

    card.querySelector('.fav-toggle').onclick = e=>{
      e.stopPropagation();
      toggleFav(c.name, e.target);
    };

    car.appendChild(card);
  });

  row.appendChild(car);
  content.appendChild(row);
}

function renderHome(filter=''){
  content.innerHTML = '';
  const grouped = groupChannels(combinedChannels || []);

  const favs = (combinedChannels||[]).filter(c=>favorites.includes(c.name));
  if(favs.length) createRow('Favorites', favs);

  Object.keys(grouped).forEach(cat=>{
    const list = grouped[cat].filter(c =>
      c.name.toLowerCase().includes(filter.toLowerCase())
    );
    if(list.length) createRow(cat, list);
  });
}

/* ===========================
   EVENTS
=========================== */
searchInput.oninput = e => renderHome(e.target.value);
favoritesTab.onclick = ()=> renderHome('');

document.addEventListener('keydown', e=>{
  if(e.key === '/' ){
    e.preventDefault();
    searchInput.focus();
  }
  if(e.key === 'Escape' && overlay.classList.contains('active')){
    exitPlayer.click();
  }
});

/* ===========================
   INIT
=========================== */
window.addEventListener('load', ()=>{
  renderHome('');

  if(lastPlayed){
    miniLogo.src = lastPlayed.logo || 'logo.png';
    miniTitle.textContent = lastPlayed.name;
    miniType.textContent = lastPlayed.type.toUpperCase();
    miniPlayer.style.display = 'flex';
  }

  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
  }
});
</script>

<!-- VIDEO PLAYER LOADER (UNCHANGED) -->
<script>
(function(){
  const b64 = "dmlkZW9wbGF5ZXIuanM=";
  const filename = atob(b64);
  const s = document.createElement('script');
  s.src = filename + "?v=" + Date.now();
  s.async = false;
  document.head.appendChild(s);
})();
</script>

</body>
</html>
